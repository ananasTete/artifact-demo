# Tiptap 富文本编辑器项目

基于 React 18 和 Tiptap 构建的功能丰富的 WYSIWYG Markdown 编辑器，支持多种交互功能和 AI 辅助编辑。

## TODO LIST

### ✅ 核心编辑器功能
- [x] **基础编辑器设置** - 基于 Tiptap 和 StarterKit 的富文本编辑器
- [x] **Markdown 支持** - 使用 marked 库解析初始 Markdown 内容
- [x] **基础格式化** - 支持粗体、斜体、删除线、代码等基本格式
- [x] **列表支持** - 有序列表和无序列表
- [x] **引用块** - 支持引用块格式
- [x] **代码块** - 支持代码块和行内代码
- [x] **链接功能** - 基础链接插入和编辑

### ✅ 斜杠命令系统
- [x] **自定义斜杠命令节点** - 使用自定义节点而非 @tiptap/suggestion 插件
- [x] **智能触发** - 仅在行首或空格后输入 '/' 时触发
- [x] **实时搜索过滤** - 根据输入内容实时过滤命令列表
- [x] **键盘导航** - 支持上下箭头键选择命令
- [x] **双空格退出** - 输入两个连续空格时退出命令模式
- [x] **Enter 键退出** - 当搜索内容无匹配时按 Enter 退出
- [x] **自动聚焦** - 节点插入时自动聚焦输入框
- [x] **失焦退出** - 输入框失去焦点时自动退出并保留输入内容
- [x] **命令执行** - 支持标题1-3、列表、引用等命令

### ✅ 链接交互功能
- [x] **悬浮菜单** - 鼠标悬浮链接时显示操作菜单
- [x] **URL 显示** - 在菜单中显示完整链接地址
- [x] **编辑功能** - 点击编辑按钮打开详细编辑面板
- [x] **复制功能** - 一键复制链接 URL
- [x] **删除功能** - 在编辑面板中删除链接
- [x] **动态定位** - 使用 getBoundingClientRect() 动态计算菜单位置
- [x] **边缘检测** - 防止菜单超出屏幕边界
- [x] **编辑锁定** - 编辑模式下菜单锁定，不响应鼠标离开事件
- [x] **全屏遮罩** - 编辑时显示透明遮罩层，点击外部关闭
- [x] **防止滚动** - 编辑面板打开时阻止页面滚动

### ✅ 文本选择和 AI 建议
- [x] **选择检测** - 鼠标释放后检测文本选择
- [x] **格式化按钮** - 粗体、斜体、删除线快速格式化
- [x] **AI 询问功能** - "询问" 按钮触发 AI 建议输入
- [x] **选择高亮** - 使用 span 元素包装选中文本并高亮显示
- [x] **跨节点选择** - 支持跨多个节点的文本选择
- [x] **智能替换** - 区分单个列表项和多个列表项的替换策略
- [x] **开放切片** - 使用 openStart 和 openEnd 防止嵌套列表创建
- [x] **浏览器默认高亮** - 保持浏览器默认的文本选择高亮效果
- [x] **选择分析** - 分析选择范围内涉及的所有节点和内容
- [x] **DOMSerializer 序列化** - 将选择内容序列化为 HTML 供 AI 处理

### ✅ 悬浮图标和 AI 处理
- [x] **段落悬浮图标** - 鼠标悬浮段落时显示 "+" 图标
- [x] **动态定位** - 图标位置根据段落位置动态计算
- [x] **高亮效果** - 悬浮时显示段落背景高亮
- [x] **锁定状态** - 点击图标后锁定高亮状态
- [x] **气泡卡片** - 点击图标显示 AI 处理输入框
- [x] **外部点击关闭** - 点击卡片外部区域关闭
- [x] **键盘快捷键** - Enter 提交，Escape 关闭
- [x] **加载状态** - 处理过程中显示加载动画
- [x] **节流处理** - 使用 lodash.throttle 优化鼠标移动性能
- [x] **延迟隐藏** - 鼠标离开后延迟隐藏图标和高亮


### ✅ Markdown 粘贴功能
- [x] **智能检测** - 自动检测粘贴内容是否包含 Markdown 语法
- [x] **语法识别** - 识别标题、列表、引用、代码块、链接等语法
- [x] **自动转换** - 使用 marked 库将 Markdown 转换为 HTML
- [x] **ProseMirror 集成** - 使用 DOMParser 和 Slice 正确插入内容
- [x] **错误处理** - 转换失败时回退到默认粘贴行为

### ✅ 不可删除的一级标题
- [x] **默认一级标题** - 编辑器初始化时自动创建不可删除的一级标题作为第一个节点
- [x] **持久化 Placeholder** - 第一个标题显示 "标题" placeholder，始终可见（即使不聚焦）
- [x] **智能保护机制** - 三层保护确保第一个标题不会被意外删除
- [x] **键盘事件拦截** - 阻止在标题开头按 Backspace 等危险操作
- [x] **事务过滤** - 精确的 filterTransaction 只阻止危险操作，允许正常功能
- [x] **自动恢复** - appendTransaction 作为最后安全网，意外删除时自动恢复
- [x] **属性保护** - 防止改变标题级别或节点类型，但允许添加 ID 等属性
- [x] **目录兼容** - 与 CustomHeading 扩展完美兼容，支持目录功能正常工作
- [x] **用户体验** - 用户可正常编辑标题内容，只是无法删除整个节点

### ✅ 扩展和插件
- [x] **SelectionHighlight 扩展** - 自定义文本选择高亮标记
- [x] **SlashCommandNode 扩展** - 自定义斜杠命令节点
- [x] **MarkdownPaste 扩展** - Markdown 粘贴处理
- [x] **Link 扩展配置** - 链接扩展的自定义配置
- [x] **ProtectedFirstHeading 扩展** - 不可删除的一级标题保护机制
- [x] **CustomPlaceholder 扩展** - 自定义 placeholder 显示逻辑

### ✅ 工具函数和 Hooks
- [x] **useHoverIcon Hook** - 悬浮图标状态管理
- [x] **textSelectionProcessor** - 文本选择处理工具
- [x] **textProcessor** - 文本处理工具
- [x] **节流优化** - 使用 lodash.throttle 优化性能

## 目录（Table of Contents）功能重构与优化

为了提升目录功能的性能、稳定性与可维护性，我们进行了一次全面的重构。

### 原始方案分析

原始的 `EnhancedTableOfContents` 组件虽然功能完备，但存在以下几个问题：

1.  **性能瓶颈**: 每次光标移动 (`selectionUpdate`) 都会触发整个目录树的重新计算和渲染，在大型文档中可能导致界面卡顿。
2.  **状态不稳定**: 目录项的 ID 是根据其在文档中的顺序动态生成的。这导致在文档中间增删标题时，后续所有标题的 ID 都会改变，使得折叠状态无法正确保持。
3.  **滚动逻辑脆弱**: 依赖 `setTimeout` 来实现滚动到标题的功能，这种方式不够稳健，可能会在不同环境或 Tiptap 版本更新后失效。
4.  **代码耦合度高**: 单个组件承担了数据提取、状态管理、UI 渲染和事件处理等多种职责，难以维护和测试。

### 优化方案与实施

针对上述问题，我们采取了以下优化措施：

#### 1. 逻辑与视图分离 (SoC)

- **创建 `useToc` Hook**: 我们将所有与 Tiptap 编辑器交互、数据提取和状态管理的逻辑抽离到一个新的自定义 Hook `useToc` (`src/hooks/useToc.ts`) 中。
- **职责划分**:
    - `useToc` 负责：从编辑器提取标题、构建层级、监听编辑器事件、更新目录数据和当前激活项。
    - `EnhancedTableOfContents` 组件负责：UI 渲染、处理用户交互（点击、折叠、搜索）。
- **优势**: 降低了组件的复杂性，使代码更清晰、可维护性更高，并且核心逻辑可以被复用和单独测试。

#### 2. 性能优化

- **分离事件监听**: 在 `useToc` Hook 中，我们将 `update` 和 `selectionUpdate` 事件的处理逻辑分开。
    - `on('update')`: 仅在文档内容实际发生变更时，才重新构建整个目录树 (`tocItems`)。
    - `on('selectionUpdate')`: 仅用于更新当前激活的标题 ID (`activeId`)，不再触发整棵树的重新计算。
- **高效的激活项检测**: 放弃了原有的数组遍历方式，改为使用 Tiptap 的 `editor.state.doc.nodesBetween` API，直接从当前光标位置向上查找最近的标题节点，性能更高。

#### 3. 增强 ID 稳定性

- **创建 `CustomHeading` 扩展**: 我们创建了一个新的 Tiptap 扩展 `CustomHeading` (`src/extensions/CustomHeading.ts`)，它继承自官方的 `Heading` 扩展。
- **持久化唯一 ID**:
    - 利用 `addAttributes` 为标题节点增加了一个 `id` 属性。
    - 通过 `appendTransaction` 插件，在创建新标题或检测到重复/缺失 ID 时，使用 `nanoid` 库为其自动生成一个唯一的、持久化的 ID。
- **优势**: 从根本上解决了 ID 不稳定的问题，确保了即使用户频繁编辑文档，目录的折叠状态也能被精确地保持。

#### 4. 改进滚动逻辑

- **放弃 `setTimeout`**: 废弃了原有的 `setTimeout` hack。
- **实现稳健的居中滚动**:
    - 首先通过标题 ID 在文档中找到节点的确切位置 (`pos`)。
    - 使用 `requestAnimationFrame` 来确保滚动操作在下一次浏览器重绘前执行，避免了视觉上的闪烁和与编辑器内部滚动的冲突。
    - 动态地向上查找真正的可滚动父容器，而不是硬编码 `'.editor-container'`，增强了组件的通用性。
    - 精确计算元素在容器中的位置，实现平滑滚动到视图正中央的效果。

### 最终成果

通过本次重构，目录功能在满足所有初始需求的基础上，实现了以下提升：

- **高性能**: 在大型文档中也能流畅运行，光标移动不再引起不必要的性能开销。
- **高稳定性**: 折叠状态和滚动定位都变得极为可靠。
- **高可维护性**: 清晰的代码结构和逻辑分离，使得未来的功能迭代和问题修复变得更加容易。
- **符合最佳实践**: 整个实现遵循了现代 React 和 Tiptap 的设计模式与最佳实践。

## 不可删除一级标题技术实现

### 设计目标

实现一个始终存在于文档开头的一级标题，该标题：
- 不能被用户删除
- 显示持久化的 "标题" placeholder
- 与现有功能（如目录）完美兼容
- 不影响其他编辑器功能

### 核心技术方案

#### 1. ProtectedFirstHeading 扩展

**三层保护机制**：

1. **filterTransaction**: 事务级别的保护
   ```typescript
   // 只阻止危险操作，允许正常功能
   if (step.jsonID === 'setNodeMarkup') {
     // ✅ 允许：添加 ID、更新属性
     // ❌ 阻止：改变节点类型或标题级别
   }

   if (step.jsonID === 'replace') {
     // ❌ 阻止：完全删除第一个节点
     // ❌ 阻止：替换为非一级标题
   }
   ```

2. **handleKeyDown**: 键盘事件拦截
   ```typescript
   // 阻止在标题开头按 Backspace
   // 阻止选择整个标题后删除
   // 阻止在空标题中的危险操作
   ```

3. **appendTransaction**: 最后的安全网
   ```typescript
   // 如果第一个标题被意外删除，自动恢复
   // 保留原有内容和 ID 属性
   ```

#### 2. CustomPlaceholder 扩展

**智能 Placeholder 显示**：
```typescript
// 第一个一级标题始终显示 placeholder
if (node.type.name === 'heading' && node.attrs.level === 1 && pos === 0) {
  return '标题';
}

// 其他节点只在聚焦时显示
if (hasAnchor && isEmpty) {
  return '输入正文...';
}
```

#### 3. 兼容性保证

**与 CustomHeading 扩展的兼容**：
- 允许 `setNodeMarkup` 操作添加 ID
- 不干扰目录功能的正常工作
- 保持标题的唯一 ID 生成机制

**与未来功能的兼容**：
- 白名单方式：只阻止明确危险的操作
- 属性友好：允许添加任何自定义属性
- 扩展友好：其他扩展的操作不受影响

### 实现文件

- `src/extensions/ProtectedFirstHeading.ts` - 核心保护逻辑
- `src/extensions/CustomPlaceholder.ts` - 智能 placeholder 显示
- `src/Tiptap.tsx` - 扩展配置和集成

### 技术特点

- **安全性**: 三层保护确保标题不会被意外删除
- **兼容性**: 与现有和未来功能完美兼容
- **用户体验**: 用户可正常编辑，只是无法删除节点
- **性能**: 最小化性能影响，只在必要时进行检查
