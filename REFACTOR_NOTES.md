# 划词输入建议功能重构说明

## 重构目标

重构划词输入建议功能，使其能够智能区分元素内划词和跨元素划词，并根据不同情况发送优化的数据结构给 AI。

## 主要改进

### 1. 智能选择分析

新增 `analyzeSelection` 函数，能够：
- 检测选择范围内涉及的所有节点
- 区分单个元素内的选择和跨元素选择
- 生成结构化的节点信息

### 2. 优化的数据结构

发送给 AI 的数据结构从简单的 HTML 字符串改为结构化对象：

```typescript
interface NodeInfo {
  from: number;    // 节点在文档中的起始位置
  to: number;      // 节点在文档中的结束位置
  content: string; // 节点的内容
}

interface AiRequestData {
  suggestion: string;  // 用户的修改建议
  nodes: NodeInfo[];   // 涉及的节点信息
}
```

### 3. 不同选择类型的处理策略

#### 元素内划词
- **特征**：选择范围只涉及一个节点
- **数据发送**：只发送选中的内容
- **用例**：在段落中选择部分文字

#### 跨元素划词
- **特征**：选择范围跨越多个节点
- **数据发送**：发送每个涉及元素的完整内容
- **用例**：从一个段落选择到另一个段落或列表

## 代码变更

### 核心函数

1. **`analyzeSelection(editor: Editor)`**
   - 分析当前选择范围
   - 返回结构化的节点信息

2. **`getAiSuggestion(requestData: AiRequestData)`**
   - 接收新的数据结构
   - 模拟 AI 处理逻辑

3. **`handleSuggestionSubmit()`**
   - 使用新的分析函数
   - 根据选择类型采用不同的替换策略

### 移除的代码

- 移除了不再使用的 `sliceToHtml` 函数
- 移除了复杂的 DOM 递归处理逻辑
- 清理了不必要的导入

## 使用示例

### 测试元素内划词
1. 在编辑器中选择段落的部分文字
2. 输入建议，如"改为更正式的语气"
3. 系统识别为元素内选择，只发送选中内容

### 测试跨元素划词
1. 从一个段落开始选择，拖拽到列表项
2. 输入建议
3. 系统识别为跨元素选择，发送每个元素的完整内容

## 技术优势

1. **更精确的上下文**：AI 能够获得完整的元素内容，而不仅仅是选中片段
2. **更好的结构理解**：通过节点位置信息，AI 能够理解文档结构
3. **灵活的处理策略**：根据选择类型采用最适合的数据发送策略
4. **更好的可维护性**：代码结构更清晰，逻辑更简单

## 后续扩展

这个重构为以下功能奠定了基础：
- 更智能的 AI 建议
- 基于上下文的内容替换
- 多种编辑模式的支持
- 更复杂的文档结构处理
